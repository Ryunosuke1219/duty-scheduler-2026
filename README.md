# 当直シフトスケジューラ

医師の当直表を自動生成するツールです。OR-Tools CP-SAT Solverを使用して、制約を満たしながら公平な割り当てを最適化します。

## 機能

- 週1回制限、日曜祝日日直月1回制限などのハード制約を遵守
- 平日1回 + 土日祝1回の公平な割り当てを最適化
- OC（オンコール）の均等配分
- 年末年始など特殊期間の事前割り当てに対応
- カレンダー形式のExcel出力

## インストール

```bash
# リポジトリをクローン
git clone https://github.com/YOUR_USERNAME/duty-scheduler.git
cd duty-scheduler

# 依存パッケージをインストール
pip install -r requirements.txt
```

## 使い方

### 基本的な使い方

```bash
python scheduler.py <CSVファイル> <年> <月>

# 例
python scheduler.py 2025_10月_shift_schedule.csv 2025 10
```

### 入力CSVの形式

```csv
Group,Name,1(Wed),2(Thu),3(Fri),4-1(Sat),4-2(Sat),...
0,医師A,0,1,0,0,0,...
1,医師B,1,0,0,0,1,...
```

- **Group**: 0=上当直(G0), 1=下当直(G1)
- **Name**: 医師名
- **日付列**: `日(曜日)` または `日-1(曜日)`（日直）, `日-2(曜日)`（当直）
- **値**:
  - `0` = 勤務可能
  - `1` = 勤務不可
  - `3` = 事前割り当て済み（当直）
  - `4` = 事前割り当て済み（OC）

### 出力ファイル

実行すると以下のファイルが生成されます：

- `YYYY_M月_schedule.xlsx` - スケジュールとサマリー
- `YYYY_M月_schedule_annotated.csv` - 割り当て結果を書き込んだCSV
- `YYYY_M月_schedule_calendar.xlsx` - カレンダー形式

## ルール

### ハード制約（必須）
- 週1回制限: 日曜〜土曜の間に当直は1回まで
- 日曜・祝日の日直は月1回まで
- 本人の不可日（1の日）は割り当て不可
- 日直(-1シフト): G0とG1から各1人
- その他シフト: G0またはG1から1人
- G1が当直 → G0からOC1人必要

### ソフト制約（最適化）
- 平日1回 + 土日祝1回を目標
- OC2回/月を目標
- 土日祝2回の場合は1回を土曜日に
- 勤務間隔4日以上を推奨

### 個別制約
- 小波津医師: 日直1回のみ、OC0回

## 年末年始など特殊期間の対応

可能な医師が極端に少ない期間は、事前に手動で割り当てを行います：

1. CSVで該当シフトのセルを `3`（当直）または `4`（OC）に変更
2. スケジューラを実行
3. 事前割り当てが固定され、残りが自動で最適化されます

## 依存パッケージ

- ortools >= 9.8
- pandas >= 2.0
- openpyxl >= 3.1

## ライセンス

MIT License
